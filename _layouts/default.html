<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page.meta_title | default: site.title }}</title>
    <meta
      name="description"
      content="{{ page.description | default: site.description }}"
    />
    <link rel="stylesheet" href="{{ '/assets/css/site.css' | relative_url }}" />
  </head>
  <body>
    <div class="page-shell">
      <main>
        <header class="hero">
          <div class="wrap hero-grid">
            <div>
              <h1>{{ page.hero_title | default: site.title }}</h1>
              <p class="lede">{{ page.hero_lede_1 }}</p>
              <p class="lede">{{ page.hero_lede_2 }}</p>
              <div class="cta-row">
                <a class="button primary" href="{{ page.primary_cta_url }}">{{ page.primary_cta_label }}</a>
                <a class="button secondary" href="{{ page.secondary_cta_url }}">{{ page.secondary_cta_label }}</a>
              </div>
            </div>
            <aside class="code-card" aria-label="Simple sample SUSTAINABILITY.md snippet">
              <h2>{{ page.code_card_title }}</h2>
              <p><a href="{{ page.code_card_link_url }}">{{ page.code_card_link_label }}</a></p>
              <pre><code>{{ page.code_snippet }}</code></pre>
            </aside>
          </div>
        </header>

        <section id="why">
          <div class="wrap">
            <h2>{{ page.why_heading }}</h2>
            <div class="prose">
              {{ content }}
            </div>
          </div>
        </section>

        <section id="framework">
          <div class="wrap">
            <h2>{{ page.framework_heading }}</h2>
            <div class="cards">
              {% for card in page.framework_cards %}
              <article class="card">
                <h3>{{ card.title }}</h3>
                <p>{{ card.body }}</p>
              </article>
              {% endfor %}
            </div>
          </div>
        </section>

        <section id="examples">
          <div class="wrap">
            <h2>{{ page.examples_heading }}</h2>
            <div class="cards">
              {% for item in page.reference_cards %}
              <article class="card">
                <h3>{{ item.title }}</h3>
                <p><a href="{{ item.url }}">{{ item.label }}</a></p>
              </article>
              {% endfor %}
            </div>
          </div>
        </section>

        <section id="adopt">
          <div class="wrap">
            <h2>{{ page.adopt_heading }}</h2>
            <div class="steps">
              {% for step in page.adopt_steps %}
              <article class="step">
                <h3>{{ step.title }}</h3>
                <p>{{ step.body }}</p>
              </article>
              {% endfor %}
            </div>
          </div>
        </section>
      </main>

      <footer class="site-footer">
        <p>
          <strong>{{ page.footer_title }}</strong> {{ page.footer_text }}
        </p>
        <p>
          <strong>Page emissions:</strong>
          <span id="footer-co2-estimate">Calculating…</span>
          ·
          <strong>Transfer:</strong>
          <span id="footer-co2-bytes">Calculating…</span>
          ·
          <strong>Green hosting:</strong>
          <span id="footer-green-hosting">Checking…</span>
        </p>
        <p>
          <small>
            Method: <a href="https://www.thegreenwebfoundation.org/news/start-calculating-digital-carbon-emissions-in-5-minutes-with-co2-js/">CO2.js quickstart</a>
            ·
            <a href="https://developers.thegreenwebfoundation.org/co2js/overview/">CO2.js docs</a>
          </small>
        </p>
        <p>
          <a href="{{ '/README.md' | relative_url }}">README</a>
          ·
          <a href="{{ '/WSG_REFERENCES.yaml' | relative_url }}">WSG References</a>
          ·
          <a href="{{ page.secondary_cta_url }}">GitHub Repo</a>
        </p>
      </footer>
    </div>

    <script type="module">
      import { co2 } from "https://cdn.jsdelivr.net/npm/@tgwf/co2@latest/dist/esm/index.js";
      import { check as greenHostingCheck } from "https://cdn.jsdelivr.net/npm/@tgwf/co2@latest/dist/esm/hosting.js";

      const estimateEl = document.getElementById("footer-co2-estimate");
      const bytesEl = document.getElementById("footer-co2-bytes");
      const hostingEl = document.getElementById("footer-green-hosting");

      const formatBytes = (bytes) => {
        if (!Number.isFinite(bytes) || bytes <= 0) return "0 B";
        const units = ["B", "KB", "MB", "GB"];
        const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        const value = bytes / (1024 ** exponent);
        return `${value.toFixed(value >= 10 || exponent === 0 ? 0 : 1)} ${units[exponent]}`;
      };

      const totalTransferBytes = () => {
        const navigation = performance.getEntriesByType("navigation");
        const resources = performance.getEntriesByType("resource");
        const entries = [...navigation, ...resources];

        return entries.reduce((total, entry) => {
          const transfer = Number(entry.transferSize) || 0;
          const encoded = Number(entry.encodedBodySize) || 0;
          return total + (transfer > 0 ? transfer : encoded);
        }, 0);
      };

      const render = async () => {
        if (!estimateEl || !bytesEl || !hostingEl) return;

        try {
          const bytes = totalTransferBytes();
          const calculator = new co2({ model: "swd", version: 4 });
          const grams = calculator.perVisit(bytes, false);

          bytesEl.textContent = formatBytes(bytes);
          estimateEl.textContent = Number.isFinite(grams) ? `${grams.toFixed(3)} gCO2e / page view` : "Unavailable";
        } catch (error) {
          bytesEl.textContent = "Unavailable";
          estimateEl.textContent = "Unavailable";
        }

        try {
          const isGreenHosted = await greenHostingCheck(window.location.hostname);
          hostingEl.textContent = isGreenHosted ? "Yes (Green Web Foundation)" : "No / unknown";
        } catch (error) {
          hostingEl.textContent = "Unavailable";
        }
      };

      if (document.readyState === "complete") {
        render();
      } else {
        window.addEventListener("load", render, { once: true });
      }
    </script>
  </body>
</html>
